CKafka 专业版支持跨可用区部署，在拥有3个或3个以上可用区的地域购买 CKafka 实例时，可以任选其中两个可用区购买跨可用区实例。该实例分区副本会强制分布在两个可用区节点上，这种部署方式能够让您的实例在单个可用区不可用情况下仍能正常提供服务。

>?仅专业版支持跨可用区部署，标准版无法支持。

## CKafka 跨可用区部署原理
CKafka 的跨可用区部署分为网络层、数据层和控制层。

#### 网络层

CKafka 会为客户端暴露一个 VIP，客户端在连接到 VIP 后，会拿到主题分区的元数据信息（该元数据通常是地址会通过同一个 VIP 的不同 port 进行一一映射）。

VIP 是一个可以随时 failover 到另一个可用区的 VIP，当某个可用区不可用时，该VIP会自动漂移到该地域另一个可用的节点，从而实现跨可用区容灾。

#### 数据层

CKafka 数据层和原生 Kafka 采用相同的分布式部署方式，即多个数据副本分布在不同 broker 节点，不同节点会部署在不同可用区。在处理某个分区时，不同的节点之间会有 leader-follower 的关系，当 leader 发生异常不在线时，集群控制节点（Controller）会选举出新的分区 leader 来承接这个分区的请求。

对于客户端来说，当某个可用区出现异常不可用后，如果某个主题分区的 leader 位于不可用区 broker 节点上，则原先建立的相关链接会出现超时或者链接被关闭的情况，当该分区 leader 节点异常之后，Controller（若 Controller 节点异常，剩余节点会竞选出新的 Controller 节点）会选举出新的leader节点提供服务，leader 切换时间在秒级（具体切换时间与集群节点个数，元数据大小成正比）。客户端会定时刷新主题分区元数据信息，链接新的 leader 节点进行生产消费。


#### 控制层

CKafka 的控制层和原生 Kafka 采用相同的技术方案，依赖 zookeeper 对 broker 节点进行服务发现和集群 Controller 选举。**支持跨可用区部署的CKafka实例，其 zookeeper 集群中 zk 节点（以下简称 zk 节点）部署在三个可用区（或机房）。**当其中任意一个可用区的 zk 节点出现故障断连，整个 zk 集群仍可以正常提供服务。

![](https://main.qcloudimg.com/raw/8f8a0366a8ab06e7322da604a4b1fa3a.png)


## 跨可用区部署优劣势

### 优势

可以大幅度提升集群的容灾能力，当单个可用区出现意外的网络不稳定、断电重启等不可抗力风险时，仍能保证客户端在短时间等待重连后恢复消息的生产和消费。

### 劣势

如果采取跨可用区部署，由于分区副本分布在多个可用区上，故消息复制相比单个可用区存在额外的跨区网络时延。主要影响如下三种情况：

- 由于Kafka 的 ISR 机制，该时延会直接影响生产时指定 ack = all 或 ack = -1 的客户端写入耗时。
- 消费的时候，Offset 的提交，是提交到内部的\_\_consumer_offset，默认的 ack 为 all，则消费的时候提交 offset 的耗时会相应提升。
- 当 Topic 的单分区流量太大的时候，副本同步由于存在时延的问题，会出现偶尔的 Follower 掉出ISR的情况。出现该情况的时候，可以增加 Topic 的分区数量，降低单分区流量。

目前广州、上海、北京几个主要地域跨可用区的时延一般在10ms~40ms。

## 跨可用区部署场景解析

### 单 AZ 不可用

单个 AZ 不可用后，如前文对原理的解析，客户端会出现断连重连，重连后服务仍能正常提供。

由于管控 API 服务目前不支持跨可用区部署，所以在单个 AZ 不可用之后，可能出现无法通过控制台创建 Topic，配置 ACL 策略，查看监控等现象，但不会影响存量业务的生产消费

### 两个 AZ 网络隔离

如果两个 AZ 之间出现网络隔离，即无法相互通信，则可能会出现集群脑裂的现象，即两个可用区的节点都提供服务，但其中一个可用区的数据写入会在集群恢复后视为脏数据。

在集群网络恢复后，客户端无需做操作即可恢复生产消费，但是由于服务端会重新对数据进行归一化，其中一个分裂节点的数据可能会被截断。

## 操作步骤

#### 购买实例选择两个可用区

1. 登录 [CKafka 控制台](https://console.cloud.tencent.com/ckafka) 。
2. 在左侧导航栏单击【实例列表】，单击【新建】进入实例购买页。
3. 在实例购买页，根据自身业务需求选择购买信息。
   ![](https://main.qcloudimg.com/raw/93a9a8d1948b5ed103fe79a26b67be2a.png)
  - 计费模式：包年包月
  - 规格类型：专业版
  - 地域：选择和部署客户端的资源相近的地域
  - 可用区：若当前地域支持多可用区部署，则可选择最多两个可用区进行部署
  - 产品规格：根据峰值带宽和磁盘容量选择对应的型号
  - 消息保留：以分钟为单位，最短保留1分钟，最长保留90天
  >?设置了消息保留时间后，过期的消息就会被删除，而删除机制是按照 Ckafka 的分片批量删除的，不是立刻删除的，目前分片的大小是1GB，如果分片不到1GB就不会删除。因此，如果您设置的保留时间是1分钟，而分片的数据大小在1分钟内无法增到1GB，那么这个时间是无效的，建议延长保留时间，具体根据数据的堆积速度而定。
  - 私有网络：若用户需要接入其他私有网络可参考 [添加路由策略](https://cloud.tencent.com/document/product/597/36348) 修改路由接入规则
  - 购买时长：可设置到期后按月自动续费
4. 单击【立即购买】，完成实例创建。
   ![](https://main.qcloudimg.com/raw/326afc4cb9999f0193695fce03a6a98a.png)

